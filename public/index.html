<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AllMind - Control Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/react-router-dom@5.3.4/umd/react-router-dom.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { margin: 0; background: #111827; }
    .loading-screen { display: flex; align-items: center; justify-content: center; height: 100vh; color: #9ca3af; font-family: system-ui; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Markdown styling */
    .markdown-content { font-size: 0.875rem; line-height: 1.6; color: #d1d5db; }
    .markdown-content h1 { font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.75rem; color: #f9fafb; }
    .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin: 0.875rem 0 0.625rem; color: #f3f4f6; }
    .markdown-content h3 { font-size: 1.125rem; font-weight: 600; margin: 0.75rem 0 0.5rem; color: #e5e7eb; }
    .markdown-content h4 { font-size: 1rem; font-weight: 600; margin: 0.625rem 0 0.5rem; color: #e5e7eb; }
    .markdown-content p { margin: 0.5rem 0; }
    .markdown-content ul, .markdown-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
    .markdown-content li { margin: 0.25rem 0; }
    .markdown-content code { background: #374151; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: ui-monospace, monospace; font-size: 0.875em; color: #e5e7eb; }
    .markdown-content pre { background: #1f2937; padding: 0.75rem; border-radius: 0.375rem; overflow-x: auto; margin: 0.75rem 0; }
    .markdown-content pre code { background: none; padding: 0; }
    .markdown-content a { color: #60a5fa; text-decoration: underline; }
    .markdown-content a:hover { color: #93c5fd; }
    .markdown-content blockquote { border-left: 3px solid #4b5563; padding-left: 1rem; margin: 0.75rem 0; color: #9ca3af; }
    .markdown-content hr { border: none; border-top: 1px solid #374151; margin: 1rem 0; }
    .markdown-content strong { font-weight: 600; color: #f3f4f6; }
    .markdown-content em { font-style: italic; }
    .markdown-content table { border-collapse: collapse; width: 100%; margin: 0.75rem 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #374151; padding: 0.5rem; text-align: left; }
    .markdown-content th { background: #1f2937; font-weight: 600; }
  </style>
</head>
<body>
  <div id="root"><div class="loading-screen">Loading AllMind Dashboard...</div></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;
    const { HashRouter, Switch, Route, useParams, useHistory, useLocation } = window.ReactRouterDOM;

    // SVG Icon paths
    const iconPaths = {
      activity: "M22 12h-4l-3 9L9 3l-3 9H2",
      database: "M3 12a9 3 0 0 0 18 0M3 6a9 3 0 0 1 18 0M3 6v12a9 3 0 0 0 18 0V6",
      terminal: "M4 17l6-6-6-6M12 19h8",
      server: "M2 5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5zM2 15a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-4zM6 7h.01M6 17h.01",
      gitBranch: "M6 3v12M18 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM6 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM18 9a9 9 0 0 1-9 9",
      refreshCw: "M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15",
      alertCircle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 8v4M12 16h.01",
      checkCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3",
      xCircle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM15 9l-6 6M9 9l6 6",
      loader2: "M21 12a9 9 0 1 1-6.219-8.56",
      search: "M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z",
      zap: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
      play: "M5 3l14 9-14 9V3z",
      stopCircle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM9 9h6v6H9z",
      rotateCcw: "M1 4v6h6M3.51 15a9 9 0 1 0 2.13-9.36L1 10",
      code: "M16 18l6-6-6-6M8 6l-6 6 6 6",
      terminalSquare: "M3 5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5zM7 15l3-3-3-3M12 17h5",
      fileText: "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8",
      chevronRight: "M9 18l6-6-6-6",
      chevronDown: "M6 9l6 6 6-6",
    };

    const Icon = ({ name, className = "w-4 h-4" }) => (
      <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" d={iconPaths[name]} />
      </svg>
    );

    // Icon components
    const Activity = ({ className }) => <Icon name="activity" className={className} />;
    const Database = ({ className }) => <Icon name="database" className={className} />;
    const Terminal = ({ className }) => <Icon name="terminal" className={className} />;
    const Server = ({ className }) => <Icon name="server" className={className} />;
    const GitBranch = ({ className }) => <Icon name="gitBranch" className={className} />;
    const RefreshCw = ({ className }) => <Icon name="refreshCw" className={className} />;
    const AlertCircle = ({ className }) => <Icon name="alertCircle" className={className} />;
    const CheckCircle = ({ className }) => <Icon name="checkCircle" className={className} />;
    const Loader2 = ({ className }) => <Icon name="loader2" className={className + " animate-spin"} />;
    const SearchIcon = ({ className }) => <Icon name="search" className={className} />;
    const Zap = ({ className }) => <Icon name="zap" className={className} />;
    const XCircle = ({ className }) => <Icon name="xCircle" className={className} />;
    const Play = ({ className }) => <Icon name="play" className={className} />;
    const StopCircle = ({ className }) => <Icon name="stopCircle" className={className} />;
    const RotateCcw = ({ className }) => <Icon name="rotateCcw" className={className} />;
    const Code = ({ className }) => <Icon name="code" className={className} />;
    const TerminalSquare = ({ className }) => <Icon name="terminalSquare" className={className} />;
    const FileText = ({ className }) => <Icon name="fileText" className={className} />;
    const ChevronRight = ({ className }) => <Icon name="chevronRight" className={className} />;
    const ChevronDown = ({ className }) => <Icon name="chevronDown" className={className} />;

    // Markdown Renderer Component
    const MarkdownRenderer = ({ content, className = "" }) => {
      const html = React.useMemo(() => {
        if (!content) return '';
        try {
          return marked.parse(content, {
            breaks: true,
            gfm: true
          });
        } catch (err) {
          console.error('Markdown parse error:', err);
          return content;
        }
      }, [content]);

      return (
        <div
          className={`markdown-content ${className}`}
          dangerouslySetInnerHTML={{ __html: html }}
        />
      );
    };

    const API_BASE = '';

    const StatusBadge = ({ status }) => {
      const styles = {
        ok: 'bg-green-500/20 text-green-400 border-green-500/30',
        running: 'bg-green-500/20 text-green-400 border-green-500/30',
        online: 'bg-green-500/20 text-green-400 border-green-500/30',
        clean: 'bg-green-500/20 text-green-400 border-green-500/30',
        error: 'bg-red-500/20 text-red-400 border-red-500/30',
        errored: 'bg-red-500/20 text-red-400 border-red-500/30',
        warning: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
        unknown: 'bg-gray-500/20 text-gray-400 border-gray-500/30',
        stopped: 'bg-gray-500/20 text-gray-400 border-gray-500/30',
        stale: 'bg-orange-500/20 text-orange-400 border-orange-500/30',
        dirty: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
        missing: 'bg-red-500/20 text-red-400 border-red-500/30',
      };
      return (
        <span className={`px-2 py-0.5 text-xs font-medium rounded border ${styles[status] || styles.unknown}`}>
          {status?.toUpperCase() || 'UNKNOWN'}
        </span>
      );
    };

    const SetupBadge = ({ setup }) => {
      const result = setup?.result || 'not_attempted';
      const styles = {
        succeeded: 'bg-green-500/20 text-green-400 border-green-500/30',
        failed: 'bg-red-500/20 text-red-400 border-red-500/30',
        skipped: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
        not_attempted: 'bg-gray-500/20 text-gray-400 border-gray-500/30',
      };
      const labels = {
        succeeded: 'SETUP: OK',
        failed: 'SETUP: FAILED',
        skipped: 'SETUP: SKIPPED',
        not_attempted: 'SETUP: PENDING',
      };
      return (
        <span className={`px-2 py-0.5 text-xs font-medium rounded border ${styles[result] || styles.not_attempted}`}>
          {labels[result] || labels.not_attempted}
        </span>
      );
    };

    const RelativeTime = ({ date }) => {
      if (!date) return <span className="text-gray-500">never</span>;
      const diffMs = new Date() - new Date(date);
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      let text = diffMins < 1 ? 'just now' : diffMins < 60 ? `${diffMins}m ago` : diffHours < 24 ? `${diffHours}h ago` : `${diffDays}d ago`;
      return <span className={diffHours > 168 ? 'text-orange-400' : 'text-gray-400'}>{text}</span>;
    };

    const formatBytes = (b) => !b ? '—' : b < 1024 ? `${b} B` : b < 1048576 ? `${(b/1024).toFixed(1)} KB` : `${(b/1048576).toFixed(1)} MB`;
    const formatUptime = (ms) => { if (!ms) return '—'; const s=Math.floor(ms/1000),m=Math.floor(s/60),h=Math.floor(m/60),d=Math.floor(h/24); return d>0?`${d}d ${h%24}h`:h>0?`${h}h ${m%60}m`:m>0?`${m}m`:`${s}s`; };

    const ServiceCard = ({ name, icon: IconComp, status, details, actions, error, loading }) => (
      <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <IconComp className="w-5 h-5 text-gray-400" />
            <span className="font-medium text-white">{name}</span>
          </div>
          {loading ? <Loader2 className="w-4 h-4 text-gray-400" /> : <StatusBadge status={status} />}
        </div>
        {error && <div className="text-xs text-red-400 mb-2 font-mono bg-red-500/10 p-2 rounded truncate">{error}</div>}
        <div className="text-sm text-gray-400 space-y-1 mb-3">
          {details.map((d, i) => <div key={i} className="flex justify-between"><span>{d.label}</span><span className="text-gray-300 truncate ml-2">{d.value}</span></div>)}
        </div>
        {actions?.length > 0 && (
          <div className="flex flex-wrap gap-2 pt-2 border-t border-gray-700">
            {actions.map((a, i) => (
              <button key={i} onClick={a.onClick} disabled={a.disabled || loading} className="text-xs px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 disabled:opacity-50 flex items-center gap-1">
                {a.icon && <a.icon className="w-3 h-3" />}{a.label}
              </button>
            ))}
          </div>
        )}
      </div>
    );

    const RepoRow = ({ repo, onAction }) => {
      const [expanded, setExpanded] = useState(false);
      return (
        <div className="border-b border-gray-700 last:border-0">
          <div className="flex items-center gap-3 p-3 hover:bg-gray-800/50 cursor-pointer" onClick={() => setExpanded(!expanded)}>
            {expanded ? <ChevronDown className="w-4 h-4 text-gray-500" /> : <ChevronRight className="w-4 h-4 text-gray-500" />}
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2">
                <span className="font-medium text-white">{repo.name}</span>
                <StatusBadge status={repo.git?.status || 'unknown'} />
                <SetupBadge setup={repo.setup} />
                {repo.git?.ahead > 0 && <span className="text-xs text-green-400">↑{repo.git.ahead}</span>}
                {repo.git?.behind > 0 && <span className="text-xs text-yellow-400">↓{repo.git.behind}</span>}
              </div>
              <div className="text-xs text-gray-500 flex gap-2 mt-0.5">
                <span>{repo.git?.branch || 'unknown'}</span>
                {repo.tools?.claudeProject && <span className="text-blue-400">claude</span>}
                {repo.tools?.venv && <span className="text-green-400">venv</span>}
                {repo.tools?.node && <span className="text-yellow-400">node</span>}
                {repo.tools?.memory && <span className="text-purple-400">memory</span>}
              </div>
            </div>
            <div className="flex gap-1">
              <button onClick={(e) => { e.stopPropagation(); onAction('open-claude', repo); }} className="p-1.5 hover:bg-gray-700 rounded" title="Open Claude"><Zap className="w-4 h-4 text-blue-400" /></button>
              <button onClick={(e) => { e.stopPropagation(); onAction('open-vscode', repo); }} className="p-1.5 hover:bg-gray-700 rounded" title="Open VS Code"><Code className="w-4 h-4 text-gray-400" /></button>
              <button onClick={(e) => { e.stopPropagation(); onAction('open-terminal', repo); }} className="p-1.5 hover:bg-gray-700 rounded" title="Open Terminal"><TerminalSquare className="w-4 h-4 text-gray-400" /></button>
            </div>
          </div>
          {expanded && (
            <div className="px-10 pb-3 text-sm">
              <div className="bg-gray-800/50 rounded p-3 space-y-2">
                <div className="text-xs text-gray-500 font-mono truncate">{repo.path}</div>
                {repo.strapEntry && <div className="flex gap-4 text-gray-400 text-xs"><span>Scope: {repo.strapEntry.scope}</span><span>Shims: {repo.strapEntry.shimCount}</span></div>}
                <div className="border-t border-gray-700 pt-2">
                  <div className="text-xs font-medium text-gray-300 mb-1">Setup</div>
                  <div className="flex gap-4 text-gray-400 text-xs">
                    <span>Status: <span className={repo.setup?.result === 'succeeded' ? 'text-green-400' : repo.setup?.result === 'failed' ? 'text-red-400' : repo.setup?.result === 'skipped' ? 'text-yellow-400' : 'text-gray-400'}>{repo.setup?.result?.toUpperCase() || 'NOT ATTEMPTED'}</span></span>
                    {repo.setup?.last_attempt && <span>Last attempt: <RelativeTime date={repo.setup.last_attempt} /></span>}
                    {!repo.setup?.last_attempt && <span>Last attempt: —</span>}
                  </div>
                  {repo.setup?.result === 'failed' && repo.setup?.error && (
                    <div className="text-xs text-red-400 mt-1">Error: {repo.setup.error}</div>
                  )}
                  {repo.setup?.result === 'failed' && !repo.setup?.error && (
                    <div className="text-xs text-red-400 mt-1">Error: No error details</div>
                  )}
                </div>
                <div className="flex gap-2 pt-2">
                  {repo.testCommand && <button onClick={() => onAction('test', repo)} className="text-xs px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-white flex items-center gap-1"><Play className="w-3 h-3" /> Run Tests</button>}
                  <button onClick={() => onAction('git-pull', repo)} className="text-xs px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-gray-300">Git Pull</button>
                  {repo.tools?.memory && <button onClick={() => onAction('view-memory', repo)} className="text-xs px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-white">View Memory</button>}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ServiceRow = ({ service, onAction, actionLoading }) => {
      const isPm2 = service.id?.startsWith('pm2-');
      const isOnline = service.status === 'online' || service.status === 'running';
      return (
        <div className="flex items-center gap-3 p-3 bg-gray-800 rounded-lg border border-gray-700">
          <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-400' : 'bg-gray-500'}`} />
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2"><span className="font-medium text-white">{service.name}</span><StatusBadge status={service.status} /></div>
            <div className="text-xs text-gray-500 flex gap-3 mt-0.5">
              {service.pid && <span>PID: {service.pid}</span>}
              {service.uptime && <span>Up: {formatUptime(service.uptime)}</span>}
              {service.memory && <span>Mem: {formatBytes(service.memory)}</span>}
              {service.restarts > 0 && <span className="text-yellow-400">Restarts: {service.restarts}</span>}
            </div>
            {service.error && <div className="text-xs text-red-400 mt-1 truncate">{service.error}</div>}
          </div>
          {isPm2 && (
            <div className="flex gap-1">
              <button onClick={() => onAction('restart', service)} disabled={actionLoading === service.id} className="p-1.5 hover:bg-gray-700 rounded disabled:opacity-50" title="Restart">
                {actionLoading === service.id ? <Loader2 className="w-4 h-4 text-gray-400" /> : <RotateCcw className="w-4 h-4 text-gray-400" />}
              </button>
              {isOnline ? <button onClick={() => onAction('stop', service)} className="p-1.5 hover:bg-gray-700 rounded" title="Stop"><StopCircle className="w-4 h-4 text-gray-400" /></button>
                : <button onClick={() => onAction('start', service)} className="p-1.5 hover:bg-gray-700 rounded" title="Start"><Play className="w-4 h-4 text-green-400" /></button>}
            </div>
          )}
        </div>
      );
    };

    const ShimRow = ({ shim }) => (
      <div className="flex items-center gap-3 p-2 hover:bg-gray-800/50 rounded">
        <Terminal className="w-4 h-4 text-gray-500" />
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span className="font-mono text-white">{shim.name}</span>
            <span className="text-xs px-1.5 py-0.5 bg-gray-700 rounded text-gray-400">{shim.type}</span>
            {!shim.cmdExists && <span className="text-xs text-yellow-400">missing .cmd</span>}
          </div>
          <div className="text-xs text-gray-500 truncate">
            {shim.repo !== 'unknown' && <span className="mr-2">repo: {shim.repo}</span>}
            {shim.exe && <span className="font-mono">{shim.exe}</span>}
          </div>
        </div>
      </div>
    );

    const DoctorCheck = ({ check }) => (
      <div className="flex items-center gap-3 p-2">
        {check.passed ? <CheckCircle className="w-4 h-4 text-green-400" /> : <XCircle className="w-4 h-4 text-red-400" />}
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <span className="text-sm text-white">{check.name}</span>
            <span className={`text-xs ${check.severity === 'critical' ? 'text-red-400' : check.severity === 'error' ? 'text-orange-400' : 'text-yellow-400'}`}>{check.severity}</span>
          </div>
          {!check.passed && check.details && <div className="text-xs text-gray-500 mt-0.5">{JSON.stringify(check.details)}</div>}
        </div>
      </div>
    );

    // Sidebar Component
    const Sidebar = ({ activeTab, setActiveTab, repos, services, loading, lastRefresh, onRefresh }) => {
      const history = useHistory();
      const location = useLocation();

      const navItems = [
        { id: 'overview', label: 'Overview', icon: Activity },
        { id: 'contexts', label: 'Contexts', icon: Database },
        { id: 'search', label: 'Search', icon: SearchIcon },
        { id: 'repos', label: 'Repos', icon: GitBranch, badge: repos.filter(r => r.git?.dirty).length || null },
        { id: 'services', label: 'Services', icon: Server, badge: services.filter(s => s.status === 'online').length || null },
        { id: 'strap', label: 'Strap', icon: Terminal },
      ];

      const isRepoRoute = location.pathname.startsWith('/repo/');
      const currentRepoName = isRepoRoute ? decodeURIComponent(location.pathname.split('/repo/')[1]) : null;

      const handleNavClick = (tabId) => {
        setActiveTab(tabId);
        history.push('/');
      };

      const handleLogoClick = () => {
        setActiveTab('overview');
        history.push('/');
      };

      const handleRepoClick = (repoName) => {
        history.push(`/repo/${encodeURIComponent(repoName)}`);
      };

      const getRepoStatus = (repo) => {
        if (repo.git?.status === 'dirty') return 'bg-yellow-400';
        if (repo.git?.status === 'clean') return 'bg-green-400';
        if (repo.git?.status === 'error') return 'bg-red-400';
        return 'bg-gray-500';
      };

      return (
        <div className="w-56 bg-gray-800 border-r border-gray-700 flex flex-col">
          <div className="p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-700/50" onClick={handleLogoClick}>
            <div className="flex items-center gap-2"><Zap className="w-6 h-6 text-blue-400" /><span className="font-bold text-lg">C3</span></div>
            <div className="text-xs text-gray-500 mt-1">Control Center</div>
          </div>
          <nav className="flex-1 p-2 overflow-auto">
            <div className="mb-3">
              {navItems.map(item => (
                <button key={item.id} onClick={() => handleNavClick(item.id)}
                  className={`w-full flex items-center gap-2 px-3 py-2 rounded text-sm ${!isRepoRoute && activeTab === item.id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-white'}`}>
                  <item.icon className="w-4 h-4" />
                  <span className="flex-1 text-left">{item.label}</span>
                  {item.badge && <span className="px-1.5 py-0.5 text-xs bg-gray-700 rounded">{item.badge}</span>}
                </button>
              ))}
            </div>
            {repos.length > 0 && (
              <div className="mt-4 pt-3 border-t border-gray-700">
                <div className="text-xs text-gray-500 px-3 mb-2">Quick Access</div>
                {repos.slice(0, 10).map(repo => (
                  <button key={repo.name} onClick={() => handleRepoClick(repo.name)}
                    className={`w-full flex items-center gap-2 px-3 py-2 rounded text-sm ${currentRepoName === repo.name ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-white'}`}>
                    <div className={`w-2 h-2 rounded-full ${getRepoStatus(repo)}`} />
                    <span className="flex-1 text-left truncate">{repo.name}</span>
                  </button>
                ))}
              </div>
            )}
          </nav>
          <div className="p-3 border-t border-gray-700 text-xs text-gray-500">
            <div className="flex items-center justify-between"><span>Last refresh</span>{lastRefresh && <RelativeTime date={lastRefresh} />}</div>
            <button onClick={onRefresh} disabled={loading} className="mt-2 w-full flex items-center justify-center gap-1 py-1.5 bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-50">
              <RefreshCw className={`w-3 h-3 ${loading ? 'animate-spin' : ''}`} /> Refresh
            </button>
          </div>
        </div>
      );
    };

    // RepoDetailView Component
    const RepoDetailView = ({ api, setError, setOutputModal, onRefresh }) => {
      const { name } = useParams();
      const history = useHistory();
      const [repo, setRepo] = useState(null);
      const [loading, setLoading] = useState(true);
      const [memoryExpanded, setMemoryExpanded] = useState({ state: false, constraints: false });

      const fetchRepo = useCallback(async () => {
        setLoading(true);
        try {
          const data = await api(`/api/repos/${encodeURIComponent(name)}`);
          setRepo(data);
        } catch (err) {
          setError(`Failed to load repo: ${err.message}`);
        } finally {
          setLoading(false);
        }
      }, [name, api, setError]);

      useEffect(() => { fetchRepo(); }, [fetchRepo]);

      const handleAction = async (action) => {
        try {
          switch (action) {
            case 'open-claude':
              await api('/api/actions/open-claude', { method: 'POST', body: JSON.stringify({ repo: name }) });
              break;
            case 'open-vscode':
              await api('/api/actions/open-vscode', { method: 'POST', body: JSON.stringify({ repo: name }) });
              break;
            case 'open-terminal':
              await api('/api/actions/open-terminal', { method: 'POST', body: JSON.stringify({ repo: name }) });
              break;
            case 'test':
              const testResult = await api(`/api/repos/${encodeURIComponent(name)}/test`, { method: 'POST' });
              setOutputModal({ title: `Test Results: ${name}`, content: testResult.stdout || testResult.stderr || 'No output', success: testResult.passed });
              break;
            case 'git-pull':
              const pullResult = await api(`/api/repos/${encodeURIComponent(name)}/git`, { method: 'POST', body: JSON.stringify({ args: ['pull'] }) });
              setOutputModal({ title: `Git Pull: ${name}`, content: pullResult.stdout || pullResult.stderr || 'No output', success: pullResult.exitCode === 0 });
              fetchRepo();
              onRefresh();
              break;
          }
        } catch (err) {
          setError(`Action failed: ${err.message}`);
        }
      };

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="flex items-center gap-2 text-gray-400">
              <Loader2 className="w-5 h-5" />
              <span>Loading repository...</span>
            </div>
          </div>
        );
      }

      if (!repo) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <XCircle className="w-12 h-12 text-red-400 mx-auto mb-3" />
              <h2 className="text-xl font-semibold mb-2">Repository Not Found</h2>
              <p className="text-gray-400 mb-4">Could not find repository: {name}</p>
              <button onClick={() => history.push('/')} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded">
                Back to Overview
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="p-6">
          {/* Breadcrumb */}
          <div className="flex items-center gap-2 text-sm text-gray-400 mb-6">
            <button onClick={() => history.push('/')} className="hover:text-white">Home</button>
            <ChevronRight className="w-4 h-4" />
            <button onClick={() => history.push('/')} className="hover:text-white">Repos</button>
            <ChevronRight className="w-4 h-4" />
            <span className="text-white">{repo.name}</span>
          </div>

          {/* Header */}
          <div className="mb-6">
            <h1 className="text-2xl font-bold mb-3">{repo.name}</h1>
            <div className="flex items-center gap-2 flex-wrap mb-3">
              <StatusBadge status={repo.git?.status || 'unknown'} />
              <SetupBadge setup={repo.setup} />
              {repo.git?.ahead > 0 && <span className="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded border border-green-500/30">↑{repo.git.ahead} ahead</span>}
              {repo.git?.behind > 0 && <span className="text-xs px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded border border-yellow-500/30">↓{repo.git.behind} behind</span>}
            </div>
            <div className="text-sm text-gray-400 flex gap-3">
              {repo.tools?.claudeProject && <span className="text-blue-400">claude</span>}
              {repo.tools?.venv && <span className="text-green-400">venv</span>}
              {repo.tools?.node && <span className="text-yellow-400">node</span>}
              {repo.tools?.memory && <span className="text-purple-400">memory</span>}
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Git Status Card */}
            <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
              <h2 className="font-semibold mb-3 flex items-center gap-2"><GitBranch className="w-4 h-4" /> Git Status</h2>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between"><span className="text-gray-400">Branch</span><span className="text-gray-300">{repo.git?.branch || 'unknown'}</span></div>
                <div className="flex justify-between"><span className="text-gray-400">Status</span><StatusBadge status={repo.git?.status || 'unknown'} /></div>
                {repo.git?.ahead > 0 && <div className="flex justify-between"><span className="text-gray-400">Ahead</span><span className="text-green-400">{repo.git.ahead} commits</span></div>}
                {repo.git?.behind > 0 && <div className="flex justify-between"><span className="text-gray-400">Behind</span><span className="text-yellow-400">{repo.git.behind} commits</span></div>}
                {repo.git?.lastCommit && (
                  <>
                    <div className="flex justify-between"><span className="text-gray-400">Last Commit</span><RelativeTime date={repo.git.lastCommit.date} /></div>
                    <div className="text-xs text-gray-500 mt-2 font-mono truncate" title={repo.git.lastCommit.message}>{repo.git.lastCommit.message}</div>
                  </>
                )}
              </div>
            </div>

            {/* Setup Card */}
            <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
              <h2 className="font-semibold mb-3">Setup Status</h2>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between"><span className="text-gray-400">Result</span><SetupBadge setup={repo.setup} /></div>
                {repo.setup?.last_attempt && <div className="flex justify-between"><span className="text-gray-400">Last Attempt</span><RelativeTime date={repo.setup.last_attempt} /></div>}
                {!repo.setup?.last_attempt && <div className="flex justify-between"><span className="text-gray-400">Last Attempt</span><span className="text-gray-500">Never</span></div>}
                {repo.setup?.result === 'failed' && repo.setup?.error && (
                  <div className="text-xs text-red-400 mt-2 p-2 bg-red-500/10 rounded">{repo.setup.error}</div>
                )}
              </div>
            </div>

            {/* Recent Commits */}
            {repo.git?.recentCommits && repo.git.recentCommits.length > 0 && (
              <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h2 className="font-semibold mb-3">Recent Commits</h2>
                <div className="space-y-2">
                  {repo.git.recentCommits.slice(0, 5).map((commit, i) => (
                    <div key={i} className="text-sm">
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-mono text-gray-500">{commit.hash?.substring(0, 7)}</span>
                        <RelativeTime date={commit.date} />
                      </div>
                      <div className="text-gray-300 text-xs mt-0.5 truncate">{commit.message}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Memory Files */}
            {repo.memory && (
              <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h2 className="font-semibold mb-3 flex items-center gap-2"><FileText className="w-4 h-4 text-purple-400" /> Memory Files</h2>
                <div className="space-y-3">
                  {repo.memory.state && (
                    <details open={memoryExpanded.state} onToggle={(e) => setMemoryExpanded({...memoryExpanded, state: e.target.open})} className="bg-gray-700/50 rounded p-2">
                      <summary className="cursor-pointer text-sm font-medium text-gray-300 hover:text-white">STATE.md</summary>
                      <div className="mt-2 max-h-64 overflow-auto">
                        <MarkdownRenderer content={repo.memory.state} />
                      </div>
                    </details>
                  )}
                  {repo.memory.constraints && (
                    <details open={memoryExpanded.constraints} onToggle={(e) => setMemoryExpanded({...memoryExpanded, constraints: e.target.open})} className="bg-gray-700/50 rounded p-2">
                      <summary className="cursor-pointer text-sm font-medium text-gray-300 hover:text-white">CONSTRAINTS.md</summary>
                      <div className="mt-2 max-h-64 overflow-auto">
                        <MarkdownRenderer content={repo.memory.constraints} />
                      </div>
                    </details>
                  )}
                </div>
              </div>
            )}

            {/* Path & Metadata */}
            <div className="bg-gray-800 rounded-lg border border-gray-700 p-4 lg:col-span-2">
              <h2 className="font-semibold mb-3">Repository Details</h2>
              <div className="text-sm space-y-2">
                <div className="flex justify-between"><span className="text-gray-400">Path</span><span className="text-gray-300 font-mono text-xs truncate ml-4">{repo.path}</span></div>
                {repo.strapEntry && (
                  <>
                    <div className="flex justify-between"><span className="text-gray-400">Scope</span><span className="text-gray-300">{repo.strapEntry.scope}</span></div>
                    <div className="flex justify-between"><span className="text-gray-400">Shims</span><span className="text-gray-300">{repo.strapEntry.shimCount}</span></div>
                  </>
                )}
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="mt-6 flex gap-3 flex-wrap">
            {repo.testCommand && (
              <button onClick={() => handleAction('test')} className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-white flex items-center gap-2">
                <Play className="w-4 h-4" /> Run Tests
              </button>
            )}
            <button onClick={() => handleAction('git-pull')} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-300">
              Git Pull
            </button>
            <button onClick={() => handleAction('open-claude')} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-white flex items-center gap-2">
              <Zap className="w-4 h-4" /> Open Claude
            </button>
            <button onClick={() => handleAction('open-vscode')} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 flex items-center gap-2">
              <Code className="w-4 h-4" /> Open VS Code
            </button>
            <button onClick={() => handleAction('open-terminal')} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-300 flex items-center gap-2">
              <TerminalSquare className="w-4 h-4" /> Open Terminal
            </button>
          </div>
        </div>
      );
    };

    // SystemView Component (formerly C3Dashboard)
    function SystemView({
      activeTab, setActiveTab,
      health, contexts, repos, services, shims, doctor,
      loading, error, setError,
      searchQuery, setSearchQuery, searchContext, setSearchContext,
      searchResults, searching,
      outputModal, setOutputModal,
      actionLoading,
      runDoctor, doSearch, handleRepoAction, handleServiceAction
    }) {
      return (
        <div className="flex-1 overflow-auto">
          <div className="p-6">
            {error && (
              <div className="mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg flex items-center gap-2 text-red-400">
                <AlertCircle className="w-4 h-4 flex-shrink-0" />
                <span className="text-sm flex-1">{error}</span>
                <button onClick={() => setError(null)} className="text-xs hover:text-red-300">dismiss</button>
              </div>
            )}

            {outputModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className="bg-gray-800 rounded-lg border border-gray-700 max-w-2xl w-full max-h-[80vh] flex flex-col">
                  <div className="flex items-center justify-between p-4 border-b border-gray-700">
                    <div className="flex items-center gap-2">
                      {outputModal.success ? <CheckCircle className="w-5 h-5 text-green-400" /> : <XCircle className="w-5 h-5 text-red-400" />}
                      <span className="font-medium">{outputModal.title}</span>
                    </div>
                    <button onClick={() => setOutputModal(null)} className="text-gray-400 hover:text-white"><XCircle className="w-5 h-5" /></button>
                  </div>
                  <div className="flex-1 overflow-auto p-4">
                    {outputModal.isMarkdown ? (
                      <MarkdownRenderer content={outputModal.content} />
                    ) : (
                      <pre className="text-sm font-mono whitespace-pre-wrap text-gray-300">{outputModal.content}</pre>
                    )}
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'overview' && (
                <div>
                  <h1 className="text-2xl font-bold mb-6">System Overview</h1>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <ServiceCard name="Chinvex API" icon={Database} status={health?.services?.find(s => s.id === 'chinvex')?.status || 'unknown'} loading={loading}
                      error={health?.services?.find(s => s.id === 'chinvex')?.error}
                      details={[{ label: 'Contexts', value: contexts.length || '—' }, { label: 'Version', value: health?.services?.find(s => s.id === 'chinvex')?.details?.version || '—' }]}
                      actions={[{ label: 'Search', icon: SearchIcon, onClick: () => setActiveTab('search') }]} />
                    <ServiceCard name="Strap" icon={Terminal} status={health?.services?.find(s => s.id === 'strap')?.status || 'unknown'} loading={loading}
                      details={[{ label: 'Shims', value: shims.shims?.length || '—' }, { label: 'Collisions', value: shims.collisions?.length || 0 }, { label: 'Orphans', value: shims.orphans?.length || 0 }]}
                      actions={[{ label: 'Doctor', icon: Activity, onClick: () => { runDoctor(); setActiveTab('strap'); } }]} />
                    <ServiceCard name="Repositories" icon={GitBranch} status={repos.length > 0 ? 'ok' : 'unknown'} loading={loading}
                      details={[{ label: 'Total', value: repos.length }, { label: 'Dirty', value: repos.filter(r => r.git?.dirty).length }, { label: 'With Memory', value: repos.filter(r => r.tools?.memory).length }]}
                      actions={[{ label: 'View All', onClick: () => setActiveTab('repos') }]} />
                    <ServiceCard name="PM2 Services" icon={Server} status={services.some(s => s.type === 'pm2' && s.status === 'online') ? 'running' : 'stopped'} loading={loading}
                      details={[{ label: 'Online', value: services.filter(s => s.status === 'online').length }, { label: 'Stopped', value: services.filter(s => s.status === 'stopped').length }, { label: 'Errored', value: services.filter(s => s.status === 'errored').length }]}
                      actions={[{ label: 'Manage', onClick: () => setActiveTab('services') }]} />
                    <ServiceCard name="C3 Backend" icon={Zap} status={health ? 'running' : 'error'} loading={loading}
                      details={[{ label: 'Host', value: health?.host?.hostname || '—' }, { label: 'Platform', value: health?.host?.platform || '—' }, { label: 'Root', value: health?.config?.strapRoot?.split('\\').pop() || '—' }]} />
                    <ServiceCard name="Cloudflare Tunnel" icon={Activity} status={services.find(s => s.id === 'cloudflared')?.status || 'unknown'} loading={loading}
                      details={[{ label: 'Status', value: services.find(s => s.id === 'cloudflared')?.status || 'unknown' }]} />
                  </div>
                  <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <h2 className="font-semibold mb-3 flex items-center gap-2"><Database className="w-4 h-4" /> Chinvex Contexts ({contexts.length})</h2>
                    {loading ? <div className="flex items-center gap-2 text-gray-400"><Loader2 className="w-4 h-4" /> Loading...</div>
                      : contexts.length === 0 ? <p className="text-gray-500">No contexts found</p>
                      : <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                          {contexts.slice(0, 8).map(ctx => (
                            <div key={ctx.name} className="bg-gray-700/50 rounded p-2 text-sm cursor-pointer hover:bg-gray-700" onClick={() => { setSearchContext(ctx.name); setActiveTab('search'); }}>
                              <div className="font-medium truncate">{ctx.name}</div>
                              <div className="text-xs text-gray-400"><RelativeTime date={ctx.updated_at} /></div>
                            </div>
                          ))}
                          {contexts.length > 8 && <div className="bg-gray-700/30 rounded p-2 text-sm text-gray-500 flex items-center justify-center cursor-pointer hover:bg-gray-700/50" onClick={() => setActiveTab('contexts')}>+{contexts.length - 8} more</div>}
                        </div>}
                  </div>
                </div>
              )}

              {activeTab === 'contexts' && (
                <div>
                  <h1 className="text-2xl font-bold mb-6">Chinvex Contexts</h1>
                  <div className="bg-gray-800 rounded-lg border border-gray-700">
                    {loading ? <div className="p-8 flex items-center justify-center gap-2 text-gray-400"><Loader2 className="w-5 h-5" /> Loading...</div>
                      : contexts.length === 0 ? <div className="p-8 text-center text-gray-500">No contexts found.</div>
                      : <div className="divide-y divide-gray-700">
                          {contexts.map(ctx => {
                            const isStale = ctx.updated_at && (new Date() - new Date(ctx.updated_at)) > 7 * 24 * 60 * 60 * 1000;
                            return (
                              <div key={ctx.name} className="flex items-center gap-3 p-3 hover:bg-gray-800/50 cursor-pointer" onClick={() => { setSearchContext(ctx.name); setActiveTab('search'); }}>
                                <Database className="w-4 h-4 text-gray-500" />
                                <div className="flex-1">
                                  <div className="flex items-center gap-2"><span className="font-medium text-white">{ctx.name}</span><StatusBadge status={isStale ? 'stale' : 'ok'} /></div>
                                  {ctx.aliases?.length > 0 && <div className="text-xs text-gray-500">aliases: {ctx.aliases.join(', ')}</div>}
                                </div>
                                <div className="text-sm text-gray-400"><RelativeTime date={ctx.updated_at} /></div>
                                <SearchIcon className="w-4 h-4 text-gray-400" />
                              </div>
                            );
                          })}
                        </div>}
                  </div>
                </div>
              )}

              {activeTab === 'search' && (
                <div>
                  <h1 className="text-2xl font-bold mb-6">Search</h1>
                  <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                    <div className="flex gap-3 mb-4">
                      <select value={searchContext} onChange={(e) => setSearchContext(e.target.value)} className="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm">
                        <option value="all">All contexts</option>
                        {contexts.map(ctx => <option key={ctx.name} value={ctx.name}>{ctx.name}</option>)}
                      </select>
                      <input type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && doSearch()} placeholder="Search query..." className="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm" />
                      <button onClick={doSearch} disabled={!searchQuery.trim() || searching} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm disabled:opacity-50 flex items-center gap-2">
                        {searching ? <Loader2 className="w-4 h-4" /> : <SearchIcon className="w-4 h-4" />} Search
                      </button>
                    </div>
                    {searchResults && (
                      <div className="space-y-3">
                        <div className="text-sm text-gray-400">{searchResults.total_results} results for "{searchResults.query}"{searchResults.contexts_searched && ` across ${searchResults.contexts_searched.length} contexts`}</div>
                        {searchResults.results?.map((r, i) => (
                          <div key={i} className="bg-gray-700/50 rounded p-3 border border-gray-600">
                            <div className="flex items-center gap-2 mb-2 flex-wrap">
                              <span className="text-xs bg-gray-600 px-2 py-0.5 rounded">{r.source_type || 'unknown'}</span>
                              {r.context && <span className="text-xs bg-blue-600/30 text-blue-400 px-2 py-0.5 rounded">{r.context}</span>}
                              <span className="text-xs text-gray-400 truncate flex-1" title={r.source_uri}>{r.source_uri?.split('\\').pop() || r.chunk_id}</span>
                              <span className="text-xs text-gray-500">rank: {r.scores?.rank?.toFixed(3) || 'N/A'}</span>
                            </div>
                            <div className="text-sm text-gray-300 font-mono whitespace-pre-wrap max-h-32 overflow-auto">{r.text?.slice(0, 500)}{r.text?.length > 500 ? '...' : ''}</div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'repos' && (
                <div>
                  <div className="flex items-center justify-between mb-6">
                    <h1 className="text-2xl font-bold">Repositories</h1>
                    <div className="text-sm text-gray-400">{repos.length} repos</div>
                  </div>
                  <div className="bg-gray-800 rounded-lg border border-gray-700">
                    {loading ? <div className="p-8 flex items-center justify-center gap-2 text-gray-400"><Loader2 className="w-5 h-5" /> Scanning...</div>
                      : repos.length === 0 ? <div className="p-8 text-center text-gray-500">No repos found.</div>
                      : repos.map(repo => <RepoRow key={repo.name} repo={repo} onAction={handleRepoAction} />)}
                  </div>
                </div>
              )}

              {activeTab === 'services' && (
                <div>
                  <h1 className="text-2xl font-bold mb-6">Services</h1>
                  <div className="space-y-3">
                    {loading ? <div className="p-8 flex items-center justify-center gap-2 text-gray-400"><Loader2 className="w-5 h-5" /> Loading...</div>
                      : services.length === 0 ? <div className="p-8 text-center text-gray-500 bg-gray-800 rounded-lg border border-gray-700">No services found.</div>
                      : services.map(service => <ServiceRow key={service.id} service={service} onAction={handleServiceAction} actionLoading={actionLoading} />)}
                  </div>
                </div>
              )}

              {activeTab === 'strap' && (
                <div>
                  <div className="flex items-center justify-between mb-6">
                    <h1 className="text-2xl font-bold">Strap</h1>
                    <button onClick={runDoctor} className="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-sm flex items-center gap-2"><Activity className="w-4 h-4" /> Run Doctor</button>
                  </div>
                  {doctor && (
                    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4 mb-6">
                      <h2 className="font-semibold mb-3 flex items-center gap-2"><Activity className="w-4 h-4" /> Doctor Results <span className="text-sm font-normal text-gray-400">{doctor.summary?.passed}/{doctor.summary?.total} passed</span></h2>
                      <div className="space-y-1">{doctor.checks?.map((check, i) => <DoctorCheck key={i} check={check} />)}</div>
                    </div>
                  )}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                      <h2 className="font-semibold mb-3 flex items-center gap-2"><Terminal className="w-4 h-4" /> Shims ({shims.shims?.length || 0})</h2>
                      <div className="max-h-96 overflow-auto space-y-1">
                        {shims.shims?.length === 0 ? <p className="text-gray-500 text-sm">No shims found</p> : shims.shims?.map((shim, i) => <ShimRow key={i} shim={shim} />)}
                      </div>
                    </div>
                    <div className="space-y-6">
                      <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <h2 className="font-semibold mb-3 flex items-center gap-2"><AlertCircle className="w-4 h-4 text-yellow-400" /> Collisions ({shims.collisions?.length || 0})</h2>
                        {shims.collisions?.length === 0 ? <p className="text-gray-500 text-sm">No collisions</p>
                          : <div className="space-y-2">{shims.collisions?.map((c, i) => (
                              <div key={i} className="text-sm p-2 bg-yellow-500/10 border border-yellow-500/30 rounded">
                                <span className="font-mono text-yellow-400">{c.shim}</span>
                                <span className="text-gray-400"> claimed by: </span>
                                <span className="text-gray-300">{c.owners?.join(', ')}</span>
                              </div>
                            ))}</div>}
                      </div>
                      <div className="bg-gray-800 rounded-lg border border-gray-700 p-4">
                        <h2 className="font-semibold mb-3 flex items-center gap-2"><FileText className="w-4 h-4 text-orange-400" /> Orphans ({shims.orphans?.length || 0})</h2>
                        {shims.orphans?.length === 0 ? <p className="text-gray-500 text-sm">No orphans</p>
                          : <div className="flex flex-wrap gap-2">{shims.orphans?.map((name, i) => <span key={i} className="text-xs font-mono px-2 py-1 bg-orange-500/20 text-orange-400 rounded">{name}</span>)}</div>}
                      </div>
                    </div>
                  </div>
                </div>
              )}
          </div>
        </div>
      );
    }

    // App Component (Main wrapper with routing)
    function App() {
      const [activeTab, setActiveTab] = useState('overview');
      const [health, setHealth] = useState(null);
      const [contexts, setContexts] = useState([]);
      const [repos, setRepos] = useState([]);
      const [services, setServices] = useState([]);
      const [shims, setShims] = useState({ shims: [], collisions: [], orphans: [] });
      const [doctor, setDoctor] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [lastRefresh, setLastRefresh] = useState(null);
      const [actionLoading, setActionLoading] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchContext, setSearchContext] = useState('all');
      const [searchResults, setSearchResults] = useState(null);
      const [searching, setSearching] = useState(false);
      const [outputModal, setOutputModal] = useState(null);

      const api = useCallback(async (path, options = {}) => {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);
        try {
          const res = await fetch(`${API_BASE}${path}`, { ...options, signal: controller.signal, headers: { 'Content-Type': 'application/json', ...options.headers } });
          if (!res.ok) { const err = await res.json().catch(() => ({ error: res.statusText })); throw new Error(err.error || res.statusText); }
          return res.json();
        } finally { clearTimeout(timeout); }
      }, []);

      const refresh = useCallback(async () => {
        setLoading(true); setError(null);
        try {
          const [healthData, contextsData, reposData, servicesData, shimsData] = await Promise.allSettled([
            api('/api/health'), api('/api/chinvex/contexts'), api('/api/repos'), api('/api/services'), api('/api/strap/shims'),
          ]);
          if (healthData.status === 'fulfilled') setHealth(healthData.value);
          if (contextsData.status === 'fulfilled') setContexts(contextsData.value.contexts || []);
          if (reposData.status === 'fulfilled') setRepos(reposData.value.repos || []);
          if (servicesData.status === 'fulfilled') setServices(servicesData.value.services || []);
          if (shimsData.status === 'fulfilled') setShims(shimsData.value);
          const failures = [healthData, contextsData, reposData, servicesData, shimsData].filter(r => r.status === 'rejected').map(r => r.reason?.message);
          if (failures.length > 0 && failures.length < 5) setError(`Some data failed: ${failures.join(', ')}`);
          else if (failures.length === 5) setError('Backend not reachable');
          setLastRefresh(new Date());
        } catch (err) { setError(err.message); }
        finally { setLoading(false); }
      }, [api]);

      const runDoctor = useCallback(async () => {
        try { const data = await api('/api/strap/doctor'); setDoctor(data); } catch (err) { setError(`Doctor failed: ${err.message}`); }
      }, [api]);

      const doSearch = async () => {
        if (!searchQuery.trim()) return;
        setSearching(true); setSearchResults(null);
        try {
          const payload = { query: searchQuery, k: 10 };
          if (searchContext === 'all') payload.contexts = 'all'; else payload.context = searchContext;
          const data = await api('/api/chinvex/search', { method: 'POST', body: JSON.stringify(payload) });
          setSearchResults(data);
        } catch (err) { setError(`Search: ${err.message}`); }
        finally { setSearching(false); }
      };

      const handleRepoAction = async (action, repo) => {
        try {
          switch (action) {
            case 'open-claude': await api('/api/actions/open-claude', { method: 'POST', body: JSON.stringify({ repo: repo.name }) }); break;
            case 'open-vscode': await api('/api/actions/open-vscode', { method: 'POST', body: JSON.stringify({ repo: repo.name }) }); break;
            case 'open-terminal': await api('/api/actions/open-terminal', { method: 'POST', body: JSON.stringify({ repo: repo.name }) }); break;
            case 'test':
              const testResult = await api(`/api/repos/${repo.name}/test`, { method: 'POST' });
              setOutputModal({ title: `Test Results: ${repo.name}`, content: testResult.stdout || testResult.stderr || 'No output', success: testResult.passed });
              break;
            case 'git-pull':
              const pullResult = await api(`/api/repos/${repo.name}/git`, { method: 'POST', body: JSON.stringify({ args: ['pull'] }) });
              setOutputModal({ title: `Git Pull: ${repo.name}`, content: pullResult.stdout || pullResult.stderr || 'No output', success: pullResult.exitCode === 0 });
              refresh();
              break;
            case 'view-memory':
              const repoDetail = await api(`/api/repos/${repo.name}`);
              setOutputModal({ title: `Memory: ${repo.name}`, content: repoDetail.memory?.state || 'No STATE.md found', success: true, isMarkdown: true });
              break;
          }
        } catch (err) { setError(`Action failed: ${err.message}`); }
      };

      const handleServiceAction = async (action, service) => {
        setActionLoading(service.id);
        try {
          await api(`/api/services/${service.id}/${action}`, { method: 'POST' });
          const servicesData = await api('/api/services');
          setServices(servicesData.services || []);
        } catch (err) { setError(`Service action failed: ${err.message}`); }
        finally { setActionLoading(null); }
      };

      useEffect(() => { refresh(); const interval = setInterval(refresh, 60000); return () => clearInterval(interval); }, [refresh]);

      return (
        <HashRouter>
          <div className="min-h-screen bg-gray-900 text-white flex">
            <Sidebar
              activeTab={activeTab}
              setActiveTab={setActiveTab}
              repos={repos}
              services={services}
              loading={loading}
              lastRefresh={lastRefresh}
              onRefresh={refresh}
            />
            <Switch>
              <Route path="/repo/:name">
                <RepoDetailView
                  api={api}
                  setError={setError}
                  setOutputModal={setOutputModal}
                  onRefresh={refresh}
                />
              </Route>
              <Route path="/">
                <SystemView
                  activeTab={activeTab}
                  setActiveTab={setActiveTab}
                  health={health}
                  contexts={contexts}
                  repos={repos}
                  services={services}
                  shims={shims}
                  doctor={doctor}
                  loading={loading}
                  error={error}
                  setError={setError}
                  searchQuery={searchQuery}
                  setSearchQuery={setSearchQuery}
                  searchContext={searchContext}
                  setSearchContext={setSearchContext}
                  searchResults={searchResults}
                  searching={searching}
                  outputModal={outputModal}
                  setOutputModal={setOutputModal}
                  actionLoading={actionLoading}
                  runDoctor={runDoctor}
                  doSearch={doSearch}
                  handleRepoAction={handleRepoAction}
                  handleServiceAction={handleServiceAction}
                />
              </Route>
            </Switch>
          </div>
        </HashRouter>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
